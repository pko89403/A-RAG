"""연구 논문 분석 에이전트 전용 반성(think) 도구."""

from __future__ import annotations

from langchain_core.tools import tool


@tool("research_paper_think", parse_docstring=True)
def research_paper_think_tool(reflection: str) -> str:
    """진행 상황을 전략적으로 점검하고 다음 행동을 명확히 기록하는 도구.

    각 검색 단계 이후 이 도구를 호출해 결과를 분석하고, 다음 단계를 체계적으로 결정한다.
    이를 통해 성급한 결론을 방지하고 근거 기반 분석을 강화한다.

    중요:
    - 각 검색 단계가 끝날 때마다 `research_paper_think`를 호출한다.
    - 다음 검색을 진행할지, 답변을 마무리할지 결정하기 전에 반드시 반성한다.

    권장 사용 시점:
    - 검색 결과 수신 직후: 어떤 핵심 정보를 확보했는가?
    - 다음 행동 결정 직전: 지금 답변 가능한가?
    - 공백 점검 시점: 아직 어떤 핵심 근거가 부족한가?
    - 최종 답변 직전: 근거 기반으로 답변을 마무리할 수 있는가?

    반성에 포함할 내용:
    1. 현재 확보한 사실/근거 분석
    2. 아직 부족한 핵심 정보(공백) 점검
    3. 근거 품질 평가(증거/예시가 충분한지)
    4. 전략적 결정(추가 검색 vs 답변 작성)
    5. 도구 선택 타당성 점검(현재 질문 의도/제약/근거 공백 기준으로 도구를 선택했는가, 동일 목적의 반복 호출을 피했는가)
    6. 인용 준비 점검:
       - refs(읽은 근거)가 1개 이상이면 cite_sources를 이미 성공시켰는가?
       - cite_sources가 missing_ids나 success=false를 반환했다면, 어떤 id를 추가로 chunk_read하고 재시도할지 명시했는가?
       - 본문에 인용 표식(cite...)을 넣을 준비가 되었는가?
       - refs가 0이라면 답변을 종료할 수 없다. 재검색/질의 재작성 또는 추가정보 요청 중 무엇을 할지 결정했는가?
       - cite_sources 호출 시 이번 턴에서 읽은 id(read_set)만 전달했는가? success=false이면 강제 루프: missing_ids chunk_read → 불가 시 id 제거/대체 → cite_sources 재시도.
       - 아직 cite_sources를 한 번도 호출하지 않았다면 즉시 호출하도록 다음 액션에 명시했는가?
    7. 도구 실행 오류 자가 치유(Self-healing) 점검:
       - 직전 단계에서 도구 실행 에러(예: INVALID_TOOL_RESULTS, MALFORMED_FUNCTION_CALL, 잘못된 파라미터)가 있었는가?
       - 있었다면 다음 호출에서 도구 선택/파라미터를 어떻게 교정할지 명시했는가?
       - 에러 원문을 사용자 최종 답변에 그대로 노출하지 않고, 내부적으로 복구 전략을 적용했는가?
    8. 루프 효율/종료 조건 가치 평가(Value Assessment):
       - 추가 도구 호출이 답변 품질을 유의미하게 개선하는가?
       - 현재 근거만으로도 논리적으로 충분한 답변이 가능한가?
       - 반복 탐색에 빠지지 않았는가(동일 목적 재검색/재정독 여부)?
    9. 목표 정합성/맥락 일관성(Goal Drift) 점검:
       - 현재 수집 중인 정보가 사용자의 최초 질문 의도와 여전히 부합하는가?
       - 장기 대화/요약 이후에도 핵심 질문을 유지하고 있는가?
    10. 모델 프로토콜/스키마 준수 점검:
       - 다음 도구 호출이 엄격한 JSON 스키마를 준수하는가(필수 필드 누락 없음)?
       - 허용되지 않은 추가 속성을 포함하지 않는가?
    11. 출력 보안 점검:
       - 최종 답변 본문에 id/source_file/page_number/도구명/내부 경로 등 내부 구조 노출 요소가 없는가?
       - "진행 제안/검색 필터/query keywords/OData 식" 같은 실행 계획·검색식 문구가 없는가?
       - "문서 후보/노드·테이블·텍스트/node/detail/page_chunk" 같은 내부 객체 라벨이 없는가?

    Args:
        reflection: 현재 발견 사항, 부족한 정보, 근거 품질, 다음 행동 계획을 담은 상세 반성 내용.

    Returns:
        분석을 위한 반성 기록이 저장되었음을 알리는 확인 문자열.
    """
    return f"Reflection recorded: {reflection}"
